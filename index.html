
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NyetRadio - Dashboard</title>
  <link rel="icon" type="image/png" href="https://files.catbox.moe/rse57p.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --neon-cyan: #00f2ff;
      --neon-yellow: #facc15;
      --neon-pink: #ff00ff;
      --dark-navy: #020617;
      --card-bg: rgba(30, 41, 59, 0.9);
    }

    .crt-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle, rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 100%); opacity: 0.1; pointer-events: none; z-index: 999; }
    .scanlines { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.1) 50%); background-size: 100% 3px; pointer-events: none; z-index: 1000; }

    body { 
      background: #020617; color: white; font-family: 'Inter', sans-serif; 
      margin: 0; padding-bottom: 50px; display: flex; justify-content: center;
      overflow-x: hidden;
    }

    .container { 
      max-width: 480px; width: 100%; min-height: 100vh; background: #0f172a; 
      position: relative; box-shadow: 0 0 50px rgba(0,0,0,1);
    }

    .header { 
      padding: 25px 20px; 
      background: linear-gradient(to bottom, #1e293b, #0f172a); 
      border-bottom-left-radius: 30px; 
      border-bottom-right-radius: 30px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .user-greet { display: flex; flex-direction: column; gap: 5px; }
    .user-info-row { display: flex; align-items: center; gap: 12px; }
    .user-greet img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
    
    .smart-info-box {
      margin-top: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-left: 3px solid var(--neon-cyan);
      border-radius: 4px;
      font-size: 10px;
      color: #94a3b8;
      display: flex;
      flex-direction: column; gap: 4px;
    }
    .info-item { display: flex; align-items: center; gap: 5px; }
    .status-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 5px #22c55e; }

    .member-badge-text { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #334155; color: #94a3b8; display: inline-block; margin-top: 2px; text-transform: uppercase; cursor: default; }
    .is-member-active { background: var(--neon-cyan) !important; color: #020617 !important; font-weight: bold; }
    .is-admin-active { background: #ef4444 !important; color: white !important; font-weight: bold; cursor: pointer; border: 1px solid white; }
    .is-crew-active { background: #facc15 !important; color: #020617 !important; font-weight: bold; }

    .right-header-area { width: 45%; display: flex; flex-direction: column; gap: 10px; }
    .quote-widget {
      background: rgba(0, 242, 255, 0.05);
      border: 1px dashed rgba(0, 242, 255, 0.3);
      padding: 10px;
      border-radius: 12px;
      min-height: 65px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    #quoteText { font-size: 11px; color: #cbd5e1; line-height: 1.4; font-style: italic; transition: opacity 0.5s; }
    #quoteAuthor { font-size: 10px; color: var(--neon-cyan); font-weight: bold; margin-top: 5px; text-align: right; }

    .prayer-widget {
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      overflow: hidden;
      padding: 5px 0;
    }
    .prayer-marquee {
      font-size: 10px;
      color: var(--neon-yellow);
      white-space: nowrap;
      display: block;
      animation: prayer-scroll 20s linear infinite;
    }
    @keyframes prayer-scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

    .player-card {
      background: var(--card-bg); border: 1px solid var(--neon-cyan);
      border-radius: 20px; padding: 20px; margin: 0 20px; margin-top: -40px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
      backdrop-filter: blur(10px);
    }

    .badge-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
    .badge-row::-webkit-scrollbar { display: none; }

    .listener-badge {
      background: rgba(0, 242, 255, 0.15); color: var(--neon-cyan);
      padding: 5px 12px; border-radius: 50px; font-size: 11px; font-weight: bold;
      border: 1px solid var(--neon-cyan); cursor: pointer; white-space: nowrap;
    }
    .speaker-badge {
      background: rgba(255, 0, 255, 0.15); color: var(--neon-pink);
      padding: 5px 12px; border-radius: 50px; font-size: 11px; font-weight: bold;
      border: 1px solid var(--neon-pink); cursor: pointer; white-space: nowrap;
    }

    .marquee-container { width: 100%; overflow: hidden; white-space: nowrap; margin: 10px 0; }
    .marquee-text { display: inline-block; color: var(--neon-yellow); font-size: 14px; animation: marquee 15s linear infinite; }
    @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

    .wave-container { display: flex; justify-content: center; align-items: flex-end; gap: 4px; height: 30px; margin-bottom: 15px; }
    .wave-bar { width: 4px; background: var(--neon-cyan); border-radius: 3px; height: 5px; transition: 0.3s; }
    .is-playing .wave-bar { animation: wave 1s ease-in-out infinite; }
    .is-playing .wave-bar:nth-child(2) { animation-delay: 0.2s; }
    .is-playing .wave-bar:nth-child(3) { animation-delay: 0.4s; }
    .is-playing .wave-bar:nth-child(4) { animation-delay: 0.6s; }
    @keyframes wave { 0%, 100% { height: 5px; } 50% { height: 30px; } }

    .btn-play-main {
        background: var(--neon-cyan); color: #020617; border: none;
        width: 65px; height: 65px; border-radius: 50%; font-size: 28px;
        display: flex; align-items: center; justify-content: center;
        margin: 15px auto; cursor: pointer; box-shadow: 0 0 20px var(--neon-cyan);
        transition: 0.3s; outline: none;
    }
    .btn-play-main:active { transform: scale(0.9); }

    .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 25px 20px 10px 20px; }
    .menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; position: relative; cursor: pointer; }
    .icon-box { 
      width: 55px; height: 55px; border-radius: 18px; background: #1e293b; 
      display: flex; align-items: center; justify-content: center; font-size: 26px; 
      border: 1px solid rgba(255,255,255,0.1); transition: 0.3s;
    }
    .menu-item span { font-size: 10px; font-weight: 500; color: #cbd5e1; text-align: center; }
    .hot-badge { position: absolute; top: -5px; right: 5px; background: #ef4444; color: white; font-size: 8px; font-weight: bold; padding: 2px 5px; border-radius: 4px; border: 1px solid #fff; z-index: 10; }

    #extraMenu { display: none; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 0 20px 20px 20px; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .toggle-container { text-align: center; padding: 10px 0; }
    .toggle-menu-btn { 
        background: transparent; border: 1px solid rgba(0, 242, 255, 0.3); color: var(--neon-cyan); 
        padding: 6px 15px; border-radius: 20px; font-size: 11px; cursor: pointer; transition: 0.3s;
    }

    .news-section { padding: 0 20px; margin-top: 20px; margin-bottom: 20px; }
    .news-header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .news-scroll { display: flex; overflow-x: auto; gap: 12px; scrollbar-width: none; padding-bottom: 5px; }
    .news-scroll::-webkit-scrollbar { display: none; }
    .news-card-mini { 
        min-width: 160px; max-width: 160px; background: #1e293b; border-radius: 12px; overflow: hidden; 
        border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; cursor: pointer;
    }
    .news-card-mini:hover { border-color: var(--neon-cyan); }
    .news-img { width: 100%; height: 90px; object-fit: cover; }
    .news-info { padding: 8px; }
    .news-tag { font-size: 8px; color: var(--neon-cyan); text-transform: uppercase; font-weight: bold; margin-bottom: 4px; display: block; }
    .news-txt { font-size: 10px; color: #f8fafc; line-height: 1.3; font-weight: 600; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
    .modal-content { background: #1e293b; width: 85%; max-width: 380px; padding: 30px; border-radius: 25px; border: 1px solid var(--neon-cyan); position: relative; max-height: 80vh; overflow-y: auto; }
    .modal-open { display: flex; }
    .close-btn { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #94a3b8; z-index: 2001; }
    .modal-title { color: var(--neon-cyan); font-weight: bold; font-size: 18px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 12px; margin-bottom: 15px; display: block; }

    .chat-section { padding: 0 20px; margin-top: 10px; }
    #chatBox { 
      height: 250px; background: rgba(0,0,0,0.4); border-radius: 15px; 
      padding: 15px; overflow-y: auto; font-size: 13px; 
      border: 1px solid #1e293b; display: flex; flex-direction: column; gap: 10px;
    }
    .chat-bubble {
      background: rgba(255,255,255,0.05); padding: 10px 12px; border-radius: 12px;
      border-left: 3px solid var(--neon-cyan); max-width: 90%; animation: fadeInChat 0.3s ease;
    }
    .chat-user { font-weight: 700; color: var(--neon-cyan); font-size: 11px; margin-bottom: 3px; display: flex; justify-content: space-between; cursor: pointer; }
    .chat-time { font-weight: 400; color: #64748b; font-size: 9px; }
    .chat-text { color: #e2e8f0; line-height: 1.4; word-wrap: break-word; }

    #chatInput { 
      width: 100%; padding: 14px; margin-top: 10px; border-radius: 12px; 
      border: 1px solid #1e293b; background: #1e293b; color: white; 
      box-sizing: border-box; outline: none; transition: 0.3s;
    }

    .live-tag { background: #ef4444; font-size: 10px; padding: 3px 8px; border-radius: 50px; animation: pulse 1.5s infinite; font-weight: bold; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    .feature-btn { background: #0f172a; border: 1px solid var(--neon-cyan); color: white; padding: 10px; border-radius: 10px; width: 100%; margin-bottom: 8px; font-size: 12px; text-align: left; cursor: pointer; }
    .online-user { padding: 8px 12px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 10px; }
    
    .member-input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; background: #0f172a; border: 1px solid #334155; color: white; outline: none; box-sizing: border-box; }
    #statusAudio { font-size: 11px; color: var(--neon-cyan); margin-top: 5px; display: block; font-weight: 600; }
    #statusAudio.needs-click { color: var(--neon-pink); font-weight: bold; animation: pulse 1.5s infinite; }
    
    .btn-stop-live { background: #ef4444 !important; color: white !important; font-weight: bold; }

    .info-mini-btn {
      position: absolute; top: 0; right: 0;
      width: 18px; height: 18px; background: #334155; color: white;
      border-radius: 50%; font-size: 10px; display: flex; align-items: center;
      justify-content: center; border: 1px solid rgba(255,255,255,0.2);
    }
  </style>
</head>
<body id="mainBody"> 
<div class="crt-overlay"></div>
<div class="scanlines"></div>

<div class="modal-overlay" id="modalOverlay">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">&times;</span>
    <span class="modal-title" id="modalTitle">Info</span>
    <div id="modalBody"></div>
  </div>
</div>

<div class="container">
  <div class="header">
    <div class="user-greet">
      <div class="user-info-row">
        <img src="https://files.catbox.moe/rse57p.png" alt="Logo">
        <div>
            <div style="font-size: 11px; opacity: 0.7;">Halo,</div>
            <div style="font-weight: 700; font-size: 16px;" id="headerUserName">Guest</div>
            <div class="member-badge-text" id="memberLabel" onclick="cekNavigasiAdmin()">Non-Member</div>
        </div>
      </div>
      <div class="smart-info-box">
          <div class="info-item"><span class="status-dot"></span> Status: <span style="color:white">Live Streaming</span></div>
          <div class="info-item">‚è∞ <span id="serverTime">00:00:00 WIB</span></div>
      </div>
    </div>
    
    <div class="right-header-area">
        <div class="quote-widget">
            <div id="quoteText">Loading wisdom...</div>
            <div id="quoteAuthor"></div>
        </div>
        <div class="prayer-widget">
            <div class="prayer-marquee" id="prayerSchedule">Memuat Jadwal Sholat...</div>
        </div>
    </div>
  </div>

  <div style="height: 35px;"></div>

  <div class="player-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <div class="badge-row">
            <span class="listener-badge" id="countDisplay" onclick="showOnlineUsers()">üë• 0 Listening</span>
            <span class="speaker-badge" id="speakerDisplay" onclick="showLiveSpeakers()" style="display:none;">üéôÔ∏è 0 Live</span>
        </div>
        <span class="live-tag">ON AIR</span>
    </div>
    
    <div class="wave-container" id="visualizer">
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
        <div class="wave-bar"></div>
    </div>

    <button id="btnPlayMain" class="btn-play-main" onclick="toggleMainAudio()">‚ñ∂Ô∏è</button>
    
    <div class="marquee-container">
        <div class="marquee-text" id="nowPlaying">NyetRadio Live Streaming - Klik Play untuk Mendengar!</div>
    </div>

    <audio id="audioPlayer" playsinline preload="none"></audio>
    <div id="statusAudio" class="needs-click">SIAP DIPUTAR</div>
  </div>

  <div class="menu-grid">
    <div class="menu-item" onclick="bukaP_Request()">
        <div class="icon-box" style="color: #ff4757;">üéµ</div><span>Request</span>
    </div>
    <div class="menu-item" onclick="bukaTopCharts()">
        <div class="icon-box" style="color: #facc15;">üìä</div><span>Top Charts</span>
    </div>
    <div class="menu-item" onclick="bukaJadwal()">
        <div class="icon-box" style="color: #1e90ff;">üìÖ</div><span>Jadwal</span>
    </div>
    <div class="menu-item" onclick="bukaTopHits()">
        <span class="hot-badge">HOT</span>
        <div class="icon-box" style="color: #ffa502;">‚≠ê</div><span>Top Hits</span>
    </div>
    
    <div class="menu-item">
        <div class="info-mini-btn" onclick="showMicInfo(event)">?</div>
        <div onclick="mintaIzinKeDendi()">
            <span class="hot-badge" id="badgeLive" style="display:none; background:#22c55e;">LIVE</span>
            <div class="icon-box" id="iconMic" style="color: #00f2ff; border: 1px solid var(--neon-cyan);">üéôÔ∏è</div><span id="labelNaikSiaran">Naik Siaran</span>
        </div>
    </div>

    <div class="menu-item" onclick="openSupportPopup()">
        <div class="icon-box" style="color: #ff9f43;">‚òï</div><span>Support</span>
    </div>
    <div class="menu-item" onclick="openInstagram()">
        <div class="icon-box" style="color: #ff7f50;">üì∏</div><span>Instagram</span>
    </div>
    <div class="menu-item" onclick="bukaPendaftaranMember()">
        <span class="hot-badge" style="background: var(--neon-cyan); color: #000;" id="badgeMemberText">JOIN</span>
        <div class="icon-box" style="color: var(--neon-cyan);" id="iconMember">üíé</div><span id="labelMemberMenu">Member</span>
    </div>
  </div>

  <div class="toggle-container">
      <button class="toggle-menu-btn" id="btnToggle" onclick="toggleExtraMenu()">Lihat Menu Lainnya ‚ñº</button>
  </div>

  <div id="extraMenu">
    <div class="menu-item" onclick="openKirimSalam()">
        <div class="icon-box" style="color: #78e08f;">‚úâÔ∏è</div><span>Kirim Salam</span>
    </div>
    <div class="menu-item" onclick="openPopup('Fanszone', 'Gabung komunitas WhatsApp atau Telegram NyetRadio melalui Admin.')">
        <div class="icon-box" style="color: #6a89cc;">üë•</div><span>Fanszone</span>
    </div>
    <div class="menu-item" onclick="openPopup('Gallery', 'Lihat foto-foto keseruan Crew NyetRadio di Instagram Kami.')">
        <div class="icon-box" style="color: #fad390;">üñºÔ∏è</div><span>Gallery</span>
    </div>
    <div class="menu-item" onclick="openPopup('Lirik Lagu', 'Fitur lirik lagu sedang dalam pengembangan. Stay tuned!')">
        <div class="icon-box" style="color: #eb2f06;">üìñ</div><span>Lirik</span>
    </div>
    <div class="menu-item" onclick="openPopup('Horoskop', 'Ramalan musik hari ini: Lagu ceria akan membuat harimu lebih berwarna!')">
        <div class="icon-box" style="color: #9c88ff;">üîÆ</div><span>Horoskop</span>
    </div>
    <div class="menu-item" onclick="window.location.href='news.php'">
        <div class="icon-box" style="color: #487eb0;">üì∞</div><span>Music News</span>
    </div>
    <div class="menu-item" onclick="openPopup('Podcast', 'Dengarkan siaran ulang NyetRadio di platform streaming kami.')">
        <div class="icon-box" style="color: #e84118;">üéß</div><span>Podcast</span>
    </div>
    <div class="menu-item" onclick="openOtherMenu()">
        <div class="icon-box" style="color: #a4b0be;">‚öôÔ∏è</div><span>Lainnya</span>
    </div>
  </div>

  <div class="news-section">
      <div class="news-header-box">
          <span style="font-weight: 700; font-size: 14px; color: var(--neon-cyan);">üî• NyetNews Terupdate</span>
          <span style="font-size: 10px; color: #94a3b8; cursor: pointer;" onclick="window.location.href='news.php'">Lihat Semua ></span>
      </div>
      <div class="news-scroll">
          <div class="news-card-mini" onclick="bacaBerita(1)">
              <img src="https://images.unsplash.com/photo-1517649763962-0c623066013b?q=80&w=400" class="news-img">
              <div class="news-info">
                  <span class="news-tag">Hukum</span>
                  <div class="news-txt">Polres Bima Jadi Tersangka Narkoba, IPW Soroti Gaya Hidup</div>
              </div>
          </div>
          <div class="news-card-mini" onclick="bacaBerita(2)">
              <img src="https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=400" class="news-img">
              <div class="news-info">
                  <span class="news-tag">Musik</span>
                  <div class="news-txt">NyetRadio Kini Hadir Dengan Fitur Live Request Terbaru</div>
              </div>
          </div>
          <div class="news-card-mini" onclick="bacaBerita(3)">
              <img src="https://images.unsplash.com/photo-1569154941061-e231b4725ef1?q=80&w=400" class="news-img">
              <div class="news-info">
                  <span class="news-tag">Travel</span>
                  <div class="news-txt">Delay 5 Jam, Penumpang Super Air Jet Malah Ditinggal</div>
              </div>
          </div>
      </div>
  </div>

  <div class="chat-section">
    <div style="font-weight: 700; margin-bottom: 12px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
        <span>üí¨ Chat Box</span>
        <span style="font-size: 10px; font-weight: 400; color: #64748b;">(Klik nama untuk membalas)</span>
    </div>
    <div id="chatBox"></div>
    <input type="text" id="chatInput" placeholder="Ketik pesan di sini...">
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.11.0.js"></script>

<script>
  // --- FIREBASE INITIALIZATION ---
  const firebaseConfig = {
    apiKey: "AIzaSyDV5K8-zseYUbtzK7QJAkyN-UnILiSFOkg",
    authDomain: "live-chat-nyet.firebaseapp.com",
    databaseURL: "https://live-chat-nyet-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "live-chat-nyet"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let userName = localStorage.getItem("nama");
  let userStatus = localStorage.getItem("userStatus") || "none"; 
  let isAdmin = false; 

  const audio = document.getElementById('audioPlayer');
  const btnPlayMain = document.getElementById('btnPlayMain');
  const statusAudio = document.getElementById('statusAudio');
  const visualizer = document.getElementById('visualizer');
  const streamUrl = "http://95.154.196.37:26618/;"; 

  function toggleMainAudio() {
      if (audio.paused || audio.src === "") {
          statusAudio.innerText = "MENGHUBUNGKAN...";
          audio.src = streamUrl + "?t=" + new Date().getTime();
          audio.load();
          setTimeout(() => {
              let playPromise = audio.play();
              if (playPromise !== undefined) {
                  playPromise.then(() => {
                      btnPlayMain.innerText = "‚è∏Ô∏è";
                      statusAudio.innerText = "STREAMING AKTIF...";
                      statusAudio.classList.remove('needs-click');
                      visualizer.classList.add('is-playing');
                  }).catch(err => {
                      statusAudio.innerText = "GAGAL HUBUNG!";
                      alert("Gagal memutar audio. Pastikan Server Radio sedang ON.");
                  });
              }
          }, 300);
      } else {
          audio.pause(); audio.src = ""; 
          btnPlayMain.innerText = "‚ñ∂Ô∏è"; statusAudio.innerText = "AUDIO BERHENTI";
          visualizer.classList.remove('is-playing');
      }
  }

  function checkUserSession() {
      if (!userName || userName === "Guest") { showWelcomePrompt(); } else { initApp(); }
  }

  function showWelcomePrompt() {
      const modal = document.getElementById('modalOverlay');
      const closeBtn = document.getElementById('closeModal');
      closeBtn.style.display = 'none'; 
      openPopup('Selamat Datang! üëã', `
        <div style="text-align:center;">
          <p style="font-size:13px; color:#cbd5e1; margin-bottom:15px;">Halo! Masukkan nama panggilanmu untuk mulai mendengarkan NyetRadio.</p>
          <input type="text" id="initialName" class="member-input" placeholder="Contoh: Budi_Keren" maxlength="15">
          <button class="feature-btn" style="text-align:center; background:var(--neon-cyan); color:black; font-weight:bold;" onclick="saveInitialName()">MULAI MENDENGAR</button>
        </div>
      `);
      modal.onclick = (e) => { if(e.target === modal) return false; };
  }

  function saveInitialName() {
      const name = document.getElementById('initialName').value.trim();
      if (name.length < 3) { alert("Nama minimal 3 karakter!"); return; }
      userName = name; localStorage.setItem("nama", name);
      db.ref('users/' + name).set({ nama: name, last_joined: firebase.database.ServerValue.TIMESTAMP, status: 'pendengar' });
      document.getElementById('closeModal').style.display = 'block';
      document.getElementById('modalOverlay').classList.remove('modal-open');
      initApp();
  }

  function initApp() {
      isAdmin = (userName && (userName.toLowerCase() === "admin" || userName.toLowerCase() === "dendi"));
      updateHeaderUI(); listenStatusChange(); joinAgoraChannel(); initPresence();
  }

  function updateHeaderUI() {
    document.getElementById('headerUserName').innerText = userName || "Guest";
    const label = document.getElementById('memberLabel');
    const menuLabel = document.getElementById('labelMemberMenu');
    const badgeMemberText = document.getElementById('badgeMemberText');

    if (isAdmin) {
        label.innerText = "OWNER / ADMIN (Klik)";
        label.className = "member-badge-text is-admin-active";
        menuLabel.innerText = "Verifikasi"; badgeMemberText.innerText = "ADMIN";
    } else if (userStatus === "Crew NyetRadio") {
        label.innerText = "Crew NyetRadio"; label.className = "member-badge-text is-crew-active";
        menuLabel.innerText = "Crew"; badgeMemberText.innerText = "CREW";
    } else if (userStatus === "member") {
        label.innerText = "Member Resmi"; label.className = "member-badge-text is-member-active";
        menuLabel.innerText = "Member"; badgeMemberText.innerText = "PRO";
    } else {
        label.innerText = (userStatus === "pending") ? "Menunggu Verifikasi" : "Non-Member";
        label.className = "member-badge-text";
        menuLabel.innerText = (userStatus === "pending") ? "Pending" : "Member";
        badgeMemberText.innerText = (userStatus === "pending") ? "WAIT" : "JOIN";
    }
  }

  function cekNavigasiAdmin() { if (isAdmin) { window.location.href = 'admin_nyet.php'; } }

  const modal = document.getElementById('modalOverlay');
  const modalCloseBtn = document.getElementById('closeModal');

  function openPopup(t, c) { 
    document.getElementById('modalTitle').innerText = t; 
    document.getElementById('modalBody').innerHTML = c; 
    modal.classList.add('modal-open'); 
  }

  window.closePopup = function() { modal.classList.remove('modal-open'); document.getElementById('modalBody').innerHTML = ''; }
  modalCloseBtn.onclick = function() { window.closePopup(); };

  // --- MENU FUNCTIONS (MENGGUNAKAN IFRAME) ---
  function bukaP_Request() { openPopup('üéµ Kirim Request Lagu', `<iframe src="p_request.php" style="width:100%; height:450px; border:none; background:transparent;"></iframe>`); }
  function bukaTopCharts() { openPopup('üìä Top Charts Minggu Ini', `<iframe src="top_charts.php" style="width:100%; height:450px; border:none; background:transparent;"></iframe>`); }
  function bukaJadwal() { openPopup('üìÖ Jadwal Siaran NyetRadio', `<iframe src="p_jadwal.php" style="width:100%; height:450px; border:none; background:transparent;"></iframe>`); }
  function bukaTopHits() { openPopup('‚≠ê NyetRadio Top Hits', `<iframe src="p_tophits.php" style="width:100%; height:450px; border:none; background:transparent;"></iframe>`); }

  function bukaPendaftaranMember() {
    if (isAdmin) { window.location.href = 'admin_nyet.php'; return; }
    if (userStatus === "pending") { openPopup('Sabar Ya!', 'Pendaftaran sedang ditinjau.'); return; }
    openPopup('Join Member üíé', `
      <div style="text-align:center;">
        <p style="font-size:12px; margin-bottom:15px;">Daftar member untuk lencana khusus.</p>
        <input type="text" id="regName" class="member-input" placeholder="Nama Lengkap" value="${userName}">
        <input type="number" id="regWa" class="member-input" placeholder="Nomor WhatsApp">
        <button class="feature-btn" style="text-align:center; background:var(--neon-cyan); color:black;" onclick="prosesDaftarMember()">AJUKAN PENDAFTARAN</button>
      </div>
    `);
  }

  function prosesDaftarMember() {
    const name = document.getElementById('regName').value.trim();
    const wa = document.getElementById('regWa').value.trim();
    if (name.length < 3 || wa.length < 10) { alert("Data tidak valid!"); return; }
    db.ref('member_requests').push({ nama: name, whatsapp: wa, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP }).then(() => {
      localStorage.setItem("userStatus", "pending"); userStatus = "pending"; updateHeaderUI(); window.closePopup();
    });
  }

  function listenStatusChange() {
      db.ref('member_verified/' + userName).on('value', (snap) => {
          const val = snap.val();
          if (val === "Admin Tetap" || val === "Admin") { isAdmin = true; userStatus = "admin"; } 
          else if (val === "Crew NyetRadio") { isAdmin = false; userStatus = "Crew NyetRadio"; } 
          else if (val === true || val === "Member NyetRadio") { isAdmin = false; userStatus = "member"; } 
          updateHeaderUI();
      });
  }

  function toggleExtraMenu() {
      const extra = document.getElementById('extraMenu');
      const btn = document.getElementById('btnToggle');
      if (extra.style.display === 'grid') { extra.style.display = 'none'; btn.innerText = 'Lihat Menu Lainnya ‚ñº'; } 
      else { extra.style.display = 'grid'; btn.innerText = 'Lihat Sedikit ‚ñ≤'; }
  }

  // --- AGORA RTC ---
  let agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
  const AGORA_APP_ID = "33b6f3d0ea0943b9bba3079479624377";
  const AGORA_CHANNEL = "NyetRadio_Live";
  let localAudioTrack = null; let myAgoraUid = null; let isAlreadyLive = false; 

  async function joinAgoraChannel() { try { if (agoraClient.connectionState !== "CONNECTED") { myAgoraUid = await agoraClient.join(AGORA_APP_ID, AGORA_CHANNEL, null, null); } } catch (err) {} }
  agoraClient.on("user-published", async (user, mediaType) => { await agoraClient.subscribe(user, mediaType); if (mediaType === "audio") { user.audioTrack.play(); } });

  async function gabungSuaraAgora() {
    try {
        if (!localAudioTrack) { localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack(); await agoraClient.publish([localAudioTrack]); }
        document.getElementById('badgeLive').style.display = 'block';
        document.getElementById('labelNaikSiaran').innerText = "Turun Siaran";
        document.getElementById('iconMic').classList.add('btn-stop-live');
        isAlreadyLive = true;
    } catch (err) { alert("Gagal Mic."); }
  }

  async function stopSiaranAgora() {
    if(localAudioTrack) { localAudioTrack.stop(); localAudioTrack.close(); localAudioTrack = null; }
    await agoraClient.unpublish();
    document.getElementById('badgeLive').style.display = 'none';
    document.getElementById('labelNaikSiaran').innerText = "Naik Siaran";
    document.getElementById('iconMic').classList.remove('btn-stop-live');
    isAlreadyLive = false;
  }

  // --- OTHER WIDGETS ---
  async function fetchPrayerTimes() {
    try {
        const response = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=2');
        const data = await response.json(); const t = data.data.timings;
        document.getElementById('prayerSchedule').innerText = `Jadwal Sholat: Subuh ${t.Fajr} ‚Ä¢ Dzuhur ${t.Dhuhr} ‚Ä¢ Ashar ${t.Asr} ‚Ä¢ Maghrib ${t.Maghrib} ‚Ä¢ Isya ${t.Isha}`;
    } catch (e) {}
  }
  fetchPrayerTimes();
  
  function updateTime() { document.getElementById('serverTime').innerText = new Date().toLocaleTimeString('id-ID') + " WIB"; }
  setInterval(updateTime, 1000); updateTime();

  const quotes = [{text:"Bila kau tak tahan lelahnya belajar, kau harus tahan perihnya kebodohan.",author:"Imam Syafi'i"},{text:"Musik adalah pemberi jiwa pada alam semesta.",author:"Plato"}];
  let currentQuoteIndex = 0;
  function updateQuote() {
    const q = quotes[currentQuoteIndex];
    document.getElementById('quoteText').innerText = `"${q.text}"`;
    document.getElementById('quoteAuthor').innerText = `- ${q.author}`;
    currentQuoteIndex = (currentQuoteIndex + 1) % quotes.length;
  }
  setInterval(updateQuote, 7000); updateQuote();

// --- SPECIAL POPUPS ---
  function openSupportPopup() {
      openPopup('Dukung NyetRadio ‚òï', `<iframe src="p_support.php" style="width:100%; height:400px; border:none; background:transparent;"></iframe>`);
  }

  function openKirimSalam() {
      openPopup('Kirim Salam Nyet ‚úâÔ∏è', `<iframe src="p_kirimsalam.php" style="width:100%; height:460px; border:none; background:transparent;"></iframe>`);
  }

  function openInstagram() {
      openPopup('Official Instagram üì∏', `<iframe src="p_instagram.php" style="width:100%; height:500px; border:none; background:transparent;"></iframe>`);
  }

  function openOtherMenu() { openPopup('Menu Tambahan', '<button class="feature-btn" onclick="setSleepTimer()">‚è∞ Sleep Timer</button>'); }
  function setSleepTimer() { let m = prompt("Menit?"); if(m) setTimeout(() => { audio.pause(); }, m * 60000); }

  // --- CHAT & PRESENCE ---
  function initPresence() {
      const myPresenceRef = db.ref('presence').push();
      db.ref('.info/connected').on('value', (s) => { if (s.val()) { myPresenceRef.onDisconnect().remove(); myPresenceRef.set({ name: userName }); } });
      db.ref('presence').on('value', (s) => { document.getElementById('countDisplay').innerText = `üë• ${s.numChildren() || 0} Listening`; });
  }

  function showLiveSpeakers() {
    db.ref('stage_requests').once('value', (snap) => {
        let h = ''; snap.forEach(child => { if(child.val().status === 'approved') { h += `<div class="online-user"><span>üéôÔ∏è ${child.val().name}</span></div>`; } });
        openPopup('Sedang Siaran', h || 'Tidak ada.');
    });
  }

  function showMicInfo(e) { e.stopPropagation(); openPopup('‚ö†Ô∏è INFO SIARAN', 'Pastikan izin mikrofon browser aktif.'); }

  async function mintaIzinKeDendi() {
    if (isAlreadyLive) { stopSiaranAgora(); return; }
    const newReq = db.ref('stage_requests').push();
    await newReq.set({ name: userName, status: 'waiting', agoraUid: myAgoraUid, timestamp: firebase.database.ServerValue.TIMESTAMP });
    newReq.on('value', (snap) => { if (snap.val() && snap.val().status === 'approved' && !isAlreadyLive) { gabungSuaraAgora(); } });
    openPopup('Request Terkirim', 'Menunggu persetujuan...');
  }

  const chatInput = document.getElementById("chatInput");
  const chatBox = document.getElementById("chatBox");
  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && chatInput.value.trim() !== "") {
      const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      db.ref("chat").push({ user: userName, text: chatInput.value, time: timeStr, isAdmin: isAdmin });
      chatInput.value = "";
    }
  });
  db.ref("chat").limitToLast(20).on("child_added", (snap) => {
    const msg = snap.val();
    const div = document.createElement("div"); div.className = "chat-bubble";
    div.innerHTML = `<div class="chat-user" onclick="replyUser('${msg.user}')"><span>${msg.user}</span><span class="chat-time">${msg.time}</span></div><div class="chat-text">${msg.text}</div>`;
    chatBox.appendChild(div); chatBox.scrollTop = chatBox.scrollHeight;
  });
  function replyUser(n) { chatInput.value = `@${n} `; chatInput.focus(); }
  function showOnlineUsers() { db.ref('presence').once('value', (s) => { let h = ''; s.forEach((c) => { h += `<div class="online-user"><span>${c.val().name}</span></div>`; }); openPopup('Online', h); }); }

  // --- NEWS ---
  const newsDataIndex = {
      1: { cat: "Hukum", title: "Polres Bima Jadi Tersangka Narkoba", img: "https://images.unsplash.com/photo-1517649763962-0c623066013b?q=80&w=400", text: "Jajaran Polres Bima kini tengah menjadi sorotan publik..." },
      2: { cat: "News", title: "NyetRadio Kini Hadir Dengan Fitur Live Request Terbaru", img: "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=400", text: "Kabar gembira buat seluruh pendengar setia NyetRadio!..." },
      3: { cat: "Travel", title: "Delay 5 Jam, Penumpang Super Air Jet Malah Ditinggal", img: "https://images.unsplash.com/photo-1436491865332-7a61a109c0f2?q=80&w=400", text: "Kisah viral penumpang pesawat..." }
  };
  function bacaBerita(id) {
      const data = newsDataIndex[id];
      openPopup('NyetNews Detail', `<div style="text-align:left;"><img src="${data.img}" style="width:100%; border-radius:15px; margin-bottom:15px; border:1px solid var(--neon-cyan);"><span style="color:var(--neon-cyan); font-size:10px; font-weight:bold; text-transform:uppercase;">${data.cat}</span><h3 style="font-size:16px; margin:10px 0; color:white;">${data.title}</h3><p style="font-size:13px; color:#cbd5e1; line-height:1.6;">${data.text}</p><button class="feature-btn" style="text-align:center; margin-top:15px;" onclick="window.location.href='news.php'">BACA BERITA LAINNYA</button></div>`);
  }

  function tampilkanPopupInfo() {
      fetch('popup_info.php')
      .then(response => response.text())
      .then(html => {
          openPopup('NyetRadio Info üìª', html);
          setTimeout(() => {
            const innerBtn = document.querySelector('#modalBody button');
            if(innerBtn) innerBtn.addEventListener('click', window.closePopup);
          }, 500);
      }).catch(err => console.log("Popup info error."));
  }

  window.onload = () => { tampilkanPopupInfo(); checkUserSession(); };
</script>
</body>
</html>