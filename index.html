<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NyetRadio - Opus Stable</title>
    <link rel="icon" type="image/png" href="https://files.catbox.moe/rse57p.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/butterchurn"></script>
    <script src="https://unpkg.com/butterchurn-presets"></script>
    <style>
        :root { --neon-cyan: #00f2ff; --neon-yellow: #facc15; --card-bg: rgba(30, 41, 59, 0.9); }
        body { background: #020617; color: white; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 50px; display: flex; justify-content: center; overflow-x: hidden; }
        .container { max-width: 480px; width: 100%; min-height: 100vh; background: #0f172a; position: relative; box-shadow: 0 0 50px #000; }
        .header { padding: 25px 20px; background: linear-gradient(to bottom, #1e293b, #0f172a); border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; display: flex; justify-content: space-between; align-items: flex-start; }
        .user-info-row { display: flex; align-items: center; gap: 12px; }
        .user-info-row img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--neon-cyan); box-shadow: 0 0 10px var(--neon-cyan); }
        .quote-widget { background: rgba(0, 242, 255, 0.05); border: 1px dashed rgba(0, 242, 255, 0.3); padding: 10px; border-radius: 12px; font-size: 11px; margin-top: 10px; font-style: italic; color: #cbd5e1; }
        .prayer-widget { background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.3); border-radius: 8px; padding: 5px; margin-top: 10px; overflow: hidden; }
        .prayer-marquee { font-size: 10px; color: var(--neon-yellow); white-space: nowrap; animation: scroll 20s linear infinite; display: block; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .player-card { background: var(--card-bg); border: 1px solid var(--neon-cyan); border-radius: 20px; padding: 15px; margin: -40px 20px 0; text-align: center; backdrop-filter: blur(10px); }
        #canvas-container { width: 100%; height: 180px; background: #000; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid #334155; }
        canvas { width: 100%; height: 100%; }
        .btn-play-main { background: var(--neon-cyan); color: #020617; border: none; width: 60px; height: 60px; border-radius: 50%; font-size: 26px; cursor: pointer; box-shadow: 0 0 20px var(--neon-cyan); margin: 10px auto; display: block; }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 25px 20px; }
        .menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; position: relative; }
        .icon-box { width: 50px; height: 50px; border-radius: 15px; background: #1e293b; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid rgba(255,255,255,0.05); }
        .menu-item span { font-size: 10px; color: #cbd5e1; }
        .news-section { padding: 0 20px; margin-bottom: 20px; }
        .news-scroll { display: flex; overflow-x: auto; gap: 12px; scrollbar-width: none; }
        .news-card { min-width: 140px; background: #1e293b; border-radius: 10px; overflow: hidden; }
        .news-card img { width: 100%; height: 70px; object-fit: cover; }
        .news-card div { padding: 8px; font-size: 10px; font-weight: bold; }
        .chat-section { padding: 0 20px; }
        #chatBox { height: 180px; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 15px; overflow-y: auto; border: 1px solid #1e293b; display: flex; flex-direction: column; gap: 8px; }
        .chat-bubble { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 10px; border-left: 3px solid var(--neon-cyan); font-size: 13px; text-align: left; }
        #chatInput { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #1e293b; background: #1e293b; color: white; box-sizing: border-box; outline: none; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: #1e293b; width: 85%; padding: 25px; border-radius: 20px; border: 1px solid var(--neon-cyan); }
        .modal-open { display: flex; }
    </style>
</head>
<body>
    <div class="modal-overlay" id="modalOverlay"><div class="modal-content"><div id="modalTitle" style="font-weight:bold; color:var(--neon-cyan); margin-bottom:10px;"></div><div id="modalBody" style="font-size:13px; line-height:1.5;"></div><button onclick="document.getElementById('modalOverlay').classList.remove('modal-open')" style="width:100%; margin-top:15px; padding:10px; background:var(--neon-cyan); border:none; border-radius:8px; font-weight:bold;">TUTUP</button></div></div>
    <div class="container">
        <div class="header">
            <div style="width: 50%;"><div class="user-info-row"><img src="https://files.catbox.moe/rse57p.png"><div><div style="font-size: 10px; opacity: 0.6;">Halo,</div><div id="headerUserName" style="font-weight:700;">Guest</div></div></div><div id="serverTime" style="font-size:11px; color:var(--neon-cyan); margin-top:5px;">00:00:00 WIB</div></div>
            <div style="width: 45%;"><div class="quote-widget" id="quoteText">"Musik adalah hidup."</div><div class="prayer-widget"><span class="prayer-marquee" id="prayerSchedule">Memuat jadwal...</span></div></div>
        </div>
        <div style="height: 40px;"></div>
        <div class="player-card">
            <div id="canvas-container"><canvas id="visualizer-canvas"></canvas><div id="presetDisplay" style="position:absolute; bottom:5px; right:10px; font-size:8px; opacity:0.5;"></div></div>
            <button id="btnPlayMain" class="btn-play-main" onclick="toggleMainAudio()">‚ñ∂Ô∏è</button>
            <div id="statusAudio" style="font-size:11px; color:var(--neon-cyan); font-weight:bold;">OPUS ENGINE READY</div>
            <audio id="audioPlayer" crossorigin="anonymous" playsinline></audio>
        </div>
        <div class="menu-grid">
            <div class="menu-item" onclick="openPopup('Request', 'Kirim request ke Admin!')"><div class="icon-box">üéµ</div><span>Request</span></div>
            <div class="menu-item" onclick="openPopup('Charts', 'Top 10 Lagu.')"><div class="icon-box">üìä</div><span>Charts</span></div>
            <div class="menu-item" onclick="openPopup('Jadwal', '24 Jam Nonstop.')"><div class="icon-box">üìÖ</div><span>Jadwal</span></div>
            <div class="menu-item" onclick="openPopup('Gallery', 'Keseruan NyetRadio.')"><div class="icon-box">üñºÔ∏è</div><span>Gallery</span></div>
        </div>
        <div class="chat-section"><div style="font-weight:bold; margin-bottom:10px;">üí¨ Chat Box</div><div id="chatBox"></div><input type="text" id="chatInput" placeholder="Tulis pesan..."></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDV5K8-zseYUbtzK7QJAkyN-UnILiSFOkg", authDomain: "live-chat-nyet.firebaseapp.com", databaseURL: "https://live-chat-nyet-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "live-chat-nyet" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const audio = document.getElementById('audioPlayer');
        // PASTIKAN ENDINGNYA .opus
        const streamUrl = "https://caring-programmes-imperial-casual.trycloudflare.com/live.opus"; 
        
        let audioContext, analyser, visualizer, isPlaying = false, animationId;
        let allPresets = {}, presetKeys = [], lastTime = 0;

        async function initEngine() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 1024;
                const source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                visualizer = butterchurn.default.createVisualizer(audioContext, document.getElementById('visualizer-canvas'), { width: 400, height: 180 });
                allPresets = butterchurnPresets.getPresets();
                presetKeys = Object.keys(allPresets);
                shufflePreset();
                setInterval(() => { if (isPlaying) shufflePreset(); }, 15000);
            }
            if (audioContext.state === 'suspended') await audioContext.resume();
        }

        function shufflePreset() {
            const key = presetKeys[Math.floor(Math.random() * presetKeys.length)];
            visualizer.loadPreset(allPresets[key], 2.0);
            document.getElementById('presetDisplay').innerText = "Vibe: " + key.substring(0, 15);
        }

        function toggleMainAudio() {
            if (audio.paused) {
                initEngine().then(() => startStream());
            } else {
                stopStream();
            }
        }

        function startStream() {
            const btn = document.getElementById('btnPlayMain');
            const status = document.getElementById('statusAudio');
            status.innerText = "BUFFERING OPUS...";
            audio.pause(); audio.src = ""; audio.load();
            audio.src = streamUrl + "?cb=" + Date.now();
            audio.play().then(() => {
                isPlaying = true; btn.innerText = "‚è∏Ô∏è"; status.innerText = "ON AIR - OPUS";
                const render = () => { if(isPlaying) { visualizer.render(); animationId = requestAnimationFrame(render); } };
                render();
            }).catch(() => { status.innerText = "RECONNECTING..."; setTimeout(startStream, 2000); });
        }

        function stopStream() {
            audio.pause(); audio.src = ""; isPlaying = false;
            document.getElementById('btnPlayMain').innerText = "‚ñ∂Ô∏è";
            document.getElementById('statusAudio').innerText = "OFFLINE";
        }

        // WATCHDOG ULTRA RECOVERY
        setInterval(() => {
            if (isPlaying) {
                if (audio.currentTime === lastTime && !audio.paused) {
                    console.log("Stuck detected, auto-fixing...");
                    startStream();
                }
                lastTime = audio.currentTime;
            }
        }, 3000);

        function openPopup(t, b) { document.getElementById('modalTitle').innerText = t; document.getElementById('modalBody').innerText = b; document.getElementById('modalOverlay').classList.add('modal-open'); }
        
        const chatInput = document.getElementById("chatInput");
        chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && chatInput.value.trim() !== "") { db.ref("chat").push({ user: localStorage.getItem("nama"), text: chatInput.value }); chatInput.value = ""; } });
        
        db.ref("chat").limitToLast(20).on("child_added", (snap) => {
            const m = snap.val();
            const div = document.createElement("div"); div.className = "chat-bubble";
            div.innerHTML = `<strong>${m.user}:</strong> ${m.text}`;
            document.getElementById('chatBox').appendChild(div);
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
        });

        window.onload = () => {
            let n = localStorage.getItem("nama");
            if (!n) { n = prompt("Siapa namamu?"); if (!n) n = "Guest" + Math.floor(Math.random() * 100); localStorage.setItem("nama", n); }
            document.getElementById('headerUserName').innerText = n;
        };
        setInterval(() => { document.getElementById('serverTime').innerText = new Date().toLocaleTimeString('id-ID') + " WIB"; }, 1000);
        fetch('https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=2').then(r => r.json()).then(d => {
            const t = d.data.timings; 
            document.getElementById('prayerSchedule').innerText = `Subuh ${t.Fajr} ‚Ä¢ Dzuhur ${t.Dhuhr} ‚Ä¢ Maghrib ${t.Maghrib} ‚Ä¢ Isya ${t.Isha}`;
        });
    </script>
</body>
</html>
