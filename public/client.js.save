const joinBtn = document.getElementById('join');
const musicEl = document.getElementById('music');
const status = document.getElementById('status');
const audioContainer = document.body;

let localStream;
const peers = {};
const socket = io();
let audioCtx;

joinBtn.onclick = async () => {
    // 1ï¸âƒ£ unlock audio context
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    await audioCtx.resume();

    try {
        // 2ï¸âƒ£ ambil mic
        const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const micSource = audioCtx.createMediaStreamSource(micStream);

        // 3ï¸âƒ£ ambil musik
        const musicSource = audioCtx.createMediaElementSource(musicEl);

        // 4ï¸âƒ£ mix mic + musik
        const destination = audioCtx.createMediaStreamDestination();
        micSource.connect(destination);
        musicSource.connect(destination);

        localStream = destination.stream;

        status.textContent = "LIVE ðŸŽ™ï¸";

        // 5ï¸âƒ£ tambahkan ke semua peer yang sudah connect
        Object.values(peers).forEach(pc => {
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        });

        console.log("âœ… Mic + musik siap dikirim ke peer");
    } catch(e) {
        console.error("Mic atau musik error:", e);
        status.textContent = "Error âŒ";
    }
};

// === Terima peer baru ===
socket.on('new-user', id => {
    const pc = new RTCPeerConnection();
    peers[id] = pc;

    if(localStream) localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = e => {
        let audio = document.getElementById('peer-' + id);
        if(!audio){
            audio = document.c
